name: TEST - Generate Single Video (No Upload)

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'core/**'
      - 'main.py'
      - '.github/workflows/test-video-generation.yml'

jobs:
  generate-test-video:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download persistent state (optional)
        id: download-state
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: persistent-state
          path: ./state
        # This step will fail if artifact doesn't exist, which is expected for test workflows
        # continue-on-error: true makes it non-blocking
      
      - name: Set up environment
        run: |
          # Create necessary directories
          mkdir -p temp output output assets
          # Copy env template if .env doesn't exist (for testing)
          if [ ! -f .env ]; then
            cp config/env_template.txt .env || echo "No env template found"
          fi
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
      
      - name: Generate test video
        run: |
          python main.py single || echo "Video generation completed or failed (expected in test)"
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        continue-on-error: true
      
      - name: Upload generated video (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-video-output
          path: output/*.mp4
          retention-days: 1
        continue-on-error: true
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            *.log
            temp/*
          retention-days: 1
        continue-on-error: true

