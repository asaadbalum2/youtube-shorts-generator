name: Production - Generate and Upload Video

on:
  schedule:
    # Run 3 times per day at optimal times
    - cron: '0 9 * * *'   # 9 AM UTC
    - cron: '0 15 * * *'  # 3 PM UTC
    - cron: '0 21 * * *'  # 9 PM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download persistent state
        id: download-state
        uses: actions/download-artifact@v4
        with:
          name: persistent-state
          path: ./state
        continue-on-error: true
        # For first run, this will fail - that's OK
      
      - name: Set up environment
        run: |
          mkdir -p temp output output assets state
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
      
      - name: Generate and upload video
        run: |
          python main.py single
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
      
      - name: Upload persistent state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: persistent-state
          path: state/*
          retention-days: 90
        continue-on-error: true
      
      - name: Upload video output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: video-output-${{ github.run_number }}
          path: output/*.mp4
          retention-days: 7
        continue-on-error: true

